#include "samantha.h"

#include <model.h>
#include <pwm.h>
#include <spi.h>
#include <sysreg.h>
#include <gpio.h>
#include <cpu.h>
#include <utils.h>

enum DisplayState
{
    DISPLAY_OFF,
    DISPLAY_ON
};

enum BacklightActivation
{
    BACKLIGHT_NO_ACTION = 0,
    BACKLIGHT_ACTIVATE_VSYNC,
    BACKLIGHT_ACTIVATE_NEXT_VSYNC
};

typedef enum
{
    SEQ_CMD_CONTROLLER_SINGLE_REG,
    SEQ_CMD_DRIVER_SINGLE_REG,
    SEQ_CMD_UNK_2,
    SEQ_CMD_GAMMA_TABLE,
    SEQ_CMD_UNK_4,
    SEQ_CMD_UNK_5,
    SEQ_CMD_UNK_6,
    SEQ_CMD_UNK_7,
    SEQ_CMD_UNK_8,
    SEQ_CMD_UNK_9,
    SEQ_CMD_FLAG_MODIFY,
    SEQ_CMD_WAIT_DELAY,
    SEQ_CMD_TERM = 0xFF
} CommandType;

typedef struct
{
    CommandType cmd;
    unsigned char reg;
    unsigned char value;
} SequenceCommand;

enum SamanthaDevice {
    SAMANTHA_DEV_CONTROLLER,
    SAMANTHA_DEV_DRIVER,
};

typedef struct 
{
    enum DisplayState active_display_state;
    enum DisplayState requested_display_state;
    unsigned int vsync_defer;
    unsigned int active_brightness;
    unsigned int requested_brightness;
    enum BacklightActivation backlight_state;
    unsigned int active_bank;
    enum SamanthaDevice active_device;
    int is_enabled_without_backlight;
    const SequenceCommand *sequence;
    unsigned char controller_flag;
} SamanthaState;

#define CONTROLLER_LOCKED   (1 << 4)

typedef enum {
    HIBARI_RES_OK,
    HIBARI_ERR_UNSUPPORED_MODEL,
    HIBARI_UNKNOWN_VERSION,
} HibariResult;

#define INVALID_REG_VALUE       (0xFFFFFFFF)

static SequenceCommand g_seq_init[] = {
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xC0, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x68, 0x04 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x10, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x12, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x14, 0x29 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x15, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x16, 0x78 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x17, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x18, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x19, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x1A, 0x44 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x1B, 0x0A },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x03, 0x87 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x04, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x05, 0x32 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x06, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x08, 0x08 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x11, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x02, 0x01 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x03, 0x07 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xA1, 0x0C },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xA2, 0x20 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xA7, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xA8, 0x03 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xA9, 0x03 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xAA, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xAB, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xAC, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xAD, 0x05 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xAE, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xAF, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB0, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB1, 0x0A },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB2, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB3, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB4, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB5, 0x09 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB6, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB7, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB8, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xB9, 0x07 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xBA, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xBB, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xBC, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xA0, 0x4F },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x02, 0x03 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x02, 0x07 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x07, 0x07 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x01, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x10, 0x02 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x11, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x12, 0x01 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x13, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x14, 0x24 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x15, 0x05 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x16, 0x09 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x17, 0x2D },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x18, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x19, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x1A, 0x81 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x1B, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x1C, 0x03 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x1D, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x50, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x51, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x52, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x53, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x54, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x55, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x57, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x90, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x91, 0x07 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x92, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x93, 0x11 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x94, 0x11 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x95, 0x12 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x96, 0x27 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x97, 0x55 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x98, 0x66 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x99, 0x77 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x9A, 0x06 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x9B, 0x07 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x9C, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x9D, 0x11 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x9E, 0x11 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x9F, 0x12 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA0, 0x27 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA1, 0x55 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA2, 0x66 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA3, 0x77 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA4, 0x06 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA5, 0x07 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA6, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA7, 0x11 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA8, 0x11 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xA9, 0x12 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xAA, 0x27 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xAB, 0x55 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xAC, 0x66 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xAD, 0x77 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0xAE, 0x06 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x23, 0x0E },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x24, 0x36 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x25, 0x03 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x26, 0x67 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x27, 0x3E },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x28, 0x64 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x29, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x2A, 0xC7 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x2B, 0x0C },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x2C, 0x27 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x2D, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x2E, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x2F, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x30, 0xEA },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x31, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x32, 0x9C },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x33, 0x0E },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x34, 0x27 },
    { SEQ_CMD_UNK_2,                     0x00, 0x00 },
    { SEQ_CMD_GAMMA_TABLE,               0x00, 0x00 },
    { SEQ_CMD_UNK_4,                     0xD3, 0x07 },
    { SEQ_CMD_UNK_5,                     0xD3, 0x07 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x41, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x42, 0x78 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x43, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x44, 0x44 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x45, 0xCB },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x46, 0xB3 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x47, 0xE5 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x48, 0xCB },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x49, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x4A, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x4B, 0x55 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x4C, 0x55 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x4E, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x4F, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x50, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x51, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x52, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x53, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x54, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x55, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x56, 0x10 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x57, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x58, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x59, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x5A, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x5B, 0x24 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x5C, 0x24 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x5D, 0x36 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x5E, 0x16 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x5F, 0x59 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x60, 0x34 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x61, 0x34 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x62, 0x34 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x63, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x64, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x65, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x66, 0xFF },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x69, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x6A, 0x16 },
    { SEQ_CMD_UNK_6,                     0xD4, 0x87 },
    { SEQ_CMD_UNK_7,                     0xD4, 0x47 },
    { SEQ_CMD_UNK_8,                     0xD4, 0x27 },
    { SEQ_CMD_UNK_9,                     0xD4, 0x17 },
    { SEQ_CMD_TERM,                      0x00, 0x00 }
};

static SequenceCommand g_seq_tcomdc[] = {
    { SEQ_CMD_CONTROLLER_SINGLE_REG,    0x9E, 0x93 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,    0x9D, 0x00 },
    { SEQ_CMD_TERM,                     0x00, 0x00 }
};

static SequenceCommand g_seq_setup[] = {
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x91, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x8C, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x82, 0x20 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x83, 0x33 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x84, 0x6C },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x85, 0xD8 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x86, 0xC8 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x88, 0x33 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x89, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x8A, 0x47 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x8B, 0x49 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_TERM,                      0x00, 0x00 }
};

static SequenceCommand g_seq_backlight_on[] = {
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x40, 0x00 },
    { SEQ_CMD_FLAG_MODIFY,               0x10, 0x01 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x21, 0x01 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x6B, 0x02 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x68, 0x43 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x67, 0x55 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x21, 0x01 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_TERM,                      0x00, 0x00 }
};

static SequenceCommand g_seq_display_on[] = {
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x10, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x80, 0x02 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x80, 0x03 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x80, 0x0B },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x86, 0xC0 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x80, 0x4B },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x80, 0x4F },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x85, 0xD0 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x80, 0x7F },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x80, 0xFF },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x85, 0xD2 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x86, 0xC2 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x20, 0x01 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x50, 0x10 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x50, 0x01 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x13, 0x40 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x1D, 0xFF },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x13, 0x50 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x90, 0x03 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0x21, 0x01 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x1D, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x13, 0x70 },
    { SEQ_CMD_WAIT_DELAY,                0x01, 0x00 },
    { SEQ_CMD_DRIVER_SINGLE_REG,         0x01, 0x01 },
    { SEQ_CMD_CONTROLLER_SINGLE_REG,     0xCF, 0x00 },
    { SEQ_CMD_TERM,                      0x00, 0x00 }
};

typedef struct
{
    uint16_t bank1[0x80];
    uint16_t bank2[0x80];
} GammaTableParams;

typedef struct
{
    uint8_t bank1[0x80];
    uint8_t bank2[0x80];
} GammaTableParams2;

#define UNK_PARAM_COUNT     (3)
#define GAMMA_TABLE_COUNT   (4)

const GammaTableParams g_gamma_table_params1[UNK_PARAM_COUNT] = {
    {
        .bank1 = { 0x0001, 0x0002, 0x0003, 0x0004, 0x0006, 0x0007, 0x0009, 0x000A, 0x000C, 0x000E, 0x000F, 0x0011, 0x0013, 0x0015, 0x0017, 0x0019, 0x001C, 0x001E, 0x0020, 0x0023, 0x0025, 0x0028, 0x002B, 0x002E, 0x0030, 0x0033, 0x0036, 0x003A, 0x003D, 0x0040, 0x0043, 0x0047, 0x004A, 0x004E, 0x0052, 0x0056, 0x005A, 0x005E, 0x0062, 0x0067, 0x006B, 0x0070, 0x0075, 0x007A, 0x007F, 0x0085, 0x008A, 0x0090, 0x0095, 0x009B, 0x00A1, 0x00A7, 0x00AE, 0x00B4, 0x00BB, 0x00C2, 0x00C8, 0x00CF, 0x00D7, 0x00DE, 0x00E5, 0x00ED, 0x00F5, 0x00FD, 0x0105, 0x010D, 0x0115, 0x011D, 0x0126, 0x012E, 0x0137, 0x0140, 0x0149, 0x0152, 0x015B, 0x0165, 0x016E, 0x0178, 0x0182, 0x018C, 0x0196, 0x01A0, 0x01AA, 0x01B4, 0x01BF, 0x01C9, 0x01D4, 0x01DF, 0x01EA, 0x01F5, 0x0200, 0x020C, 0x0217, 0x0223, 0x022F, 0x023B, 0x0247, 0x0253, 0x025F, 0x026B, 0x0278, 0x0284, 0x0291, 0x029D, 0x02AA, 0x02B7, 0x02C4, 0x02D1, 0x02DE, 0x02EC, 0x02F9, 0x0307, 0x0314, 0x0322, 0x0330, 0x033E, 0x034C, 0x035A, 0x0368, 0x0377, 0x0385, 0x0394, 0x03A2, 0x03B1, 0x03C0, 0x03CF, 0x03DE, 0x03ED },
        .bank2 = { 0x03FC, 0x040C, 0x041B, 0x042B, 0x043B, 0x044B, 0x045B, 0x046B, 0x047C, 0x048C, 0x049D, 0x04AE, 0x04BF, 0x04D1, 0x04E2, 0x04F4, 0x0505, 0x0517, 0x0529, 0x053C, 0x054E, 0x0560, 0x0573, 0x0586, 0x0599, 0x05AC, 0x05BF, 0x05D3, 0x05E7, 0x05FA, 0x060E, 0x0622, 0x0637, 0x064B, 0x0660, 0x0674, 0x0689, 0x069E, 0x06B3, 0x06C8, 0x06DE, 0x06F3, 0x0709, 0x071F, 0x0735, 0x074B, 0x0761, 0x0777, 0x078E, 0x07A4, 0x07BB, 0x07D2, 0x07E9, 0x0800, 0x0818, 0x082F, 0x0847, 0x085F, 0x0876, 0x088F, 0x08A7, 0x08BF, 0x08D8, 0x08F0, 0x0909, 0x0922, 0x093B, 0x0954, 0x096D, 0x0986, 0x099F, 0x09B9, 0x09D2, 0x09EC, 0x0A06, 0x0A1F, 0x0A39, 0x0A53, 0x0A6D, 0x0A87, 0x0AA2, 0x0ABC, 0x0AD6, 0x0AF1, 0x0B0C, 0x0B26, 0x0B41, 0x0B5C, 0x0B77, 0x0B92, 0x0BAD, 0x0BC9, 0x0BE4, 0x0BFF, 0x0C1B, 0x0C37, 0x0C52, 0x0C6E, 0x0C8A, 0x0CA6, 0x0CC3, 0x0CDF, 0x0CFC, 0x0D18, 0x0D35, 0x0D52, 0x0D6F, 0x0D8D, 0x0DAA, 0x0DC8, 0x0DE5, 0x0E03, 0x0E21, 0x0E3F, 0x0E5D, 0x0E7C, 0x0E9A, 0x0EB9, 0x0ED8, 0x0EF6, 0x0F16, 0x0F35, 0x0F54, 0x0F73, 0x0F93, 0x0FB3, 0x0FD3, 0x0FF3 },
    },
    {
        .bank1 = { 0x0001, 0x0002, 0x0003, 0x0004, 0x0006, 0x0007, 0x0009, 0x000A, 0x000C, 0x000E, 0x000F, 0x0011, 0x0013, 0x0015, 0x0017, 0x0019, 0x001C, 0x001E, 0x0020, 0x0023, 0x0025, 0x0028, 0x002B, 0x002E, 0x0030, 0x0033, 0x0036, 0x003A, 0x003D, 0x0040, 0x0043, 0x0047, 0x004A, 0x004E, 0x0052, 0x0056, 0x005A, 0x005E, 0x0062, 0x0066, 0x006B, 0x006F, 0x0074, 0x0079, 0x007E, 0x0083, 0x0088, 0x008E, 0x0093, 0x0099, 0x009F, 0x00A5, 0x00AB, 0x00B1, 0x00B7, 0x00BD, 0x00C4, 0x00CA, 0x00D1, 0x00D8, 0x00DF, 0x00E6, 0x00ED, 0x00F5, 0x00FC, 0x0104, 0x010C, 0x0114, 0x011C, 0x0124, 0x012C, 0x0134, 0x013D, 0x0145, 0x014E, 0x0157, 0x0160, 0x0169, 0x0172, 0x017C, 0x0185, 0x018F, 0x0199, 0x01A3, 0x01AD, 0x01B7, 0x01C1, 0x01CB, 0x01D6, 0x01E0, 0x01EB, 0x01F6, 0x0201, 0x020C, 0x0217, 0x0223, 0x022E, 0x023A, 0x0246, 0x0251, 0x025D, 0x0269, 0x0276, 0x0282, 0x028E, 0x029B, 0x02A7, 0x02B4, 0x02C1, 0x02CE, 0x02DB, 0x02E8, 0x02F5, 0x0302, 0x0310, 0x031E, 0x032B, 0x0339, 0x0347, 0x0355, 0x0363, 0x0371, 0x0380, 0x038E, 0x039D, 0x03AB, 0x03BA, 0x03C9 },
        .bank2 = { 0x03D8, 0x03E7, 0x03F6, 0x0406, 0x0415, 0x0425, 0x0435, 0x0445, 0x0455, 0x0466, 0x0476, 0x0487, 0x0498, 0x04A9, 0x04BA, 0x04CB, 0x04DC, 0x04EE, 0x04FF, 0x0511, 0x0523, 0x0535, 0x0548, 0x055A, 0x056D, 0x057F, 0x0592, 0x05A5, 0x05B8, 0x05CC, 0x05DF, 0x05F3, 0x0606, 0x061A, 0x062E, 0x0643, 0x0657, 0x066B, 0x0680, 0x0695, 0x06AA, 0x06BF, 0x06D4, 0x06EA, 0x0700, 0x0715, 0x072B, 0x0741, 0x0758, 0x076E, 0x0785, 0x079B, 0x07B2, 0x07C9, 0x07E0, 0x07F8, 0x080F, 0x0827, 0x083F, 0x0857, 0x086F, 0x0887, 0x08A0, 0x08B8, 0x08D1, 0x08EA, 0x0903, 0x091C, 0x0935, 0x094F, 0x0968, 0x0982, 0x099B, 0x09B5, 0x09CF, 0x09E9, 0x0A04, 0x0A1E, 0x0A39, 0x0A53, 0x0A6E, 0x0A89, 0x0AA4, 0x0ABF, 0x0ADA, 0x0AF6, 0x0B11, 0x0B2D, 0x0B48, 0x0B64, 0x0B80, 0x0B9C, 0x0BB9, 0x0BD5, 0x0BF2, 0x0C0E, 0x0C2B, 0x0C48, 0x0C65, 0x0C82, 0x0C9F, 0x0CBD, 0x0CDB, 0x0CF8, 0x0D16, 0x0D35, 0x0D53, 0x0D71, 0x0D90, 0x0DAF, 0x0DCD, 0x0DED, 0x0E0C, 0x0E2B, 0x0E4B, 0x0E6A, 0x0E8A, 0x0EAA, 0x0ECA, 0x0EEA, 0x0F0B, 0x0F2B, 0x0F4C, 0x0F6D, 0x0F8E, 0x0FAF, 0x0FD1, 0x0FF2 },
    },
    {
        .bank1 = { 0x0002, 0x0003, 0x0005, 0x0007, 0x0009, 0x000B, 0x000D, 0x0010, 0x0012, 0x0015, 0x0017, 0x001A, 0x001D, 0x0020, 0x0024, 0x0027, 0x002B, 0x002E, 0x0032, 0x0036, 0x003A, 0x003E, 0x0042, 0x0047, 0x004B, 0x0050, 0x0054, 0x0059, 0x005E, 0x0063, 0x0069, 0x006E, 0x0074, 0x0079, 0x007F, 0x0085, 0x008B, 0x0091, 0x0098, 0x009F, 0x00A5, 0x00AC, 0x00B4, 0x00BB, 0x00C2, 0x00CA, 0x00D2, 0x00DA, 0x00E2, 0x00EA, 0x00F3, 0x00FB, 0x0104, 0x010D, 0x0116, 0x011F, 0x0129, 0x0132, 0x013C, 0x0146, 0x0150, 0x015A, 0x0165, 0x016F, 0x017A, 0x0185, 0x0190, 0x019B, 0x01A7, 0x01B2, 0x01BE, 0x01CA, 0x01D6, 0x01E3, 0x01EF, 0x01FC, 0x0209, 0x0216, 0x0223, 0x0230, 0x023E, 0x024B, 0x0259, 0x0267, 0x0275, 0x0284, 0x0292, 0x02A1, 0x02B0, 0x02BF, 0x02CE, 0x02DD, 0x02ED, 0x02FD, 0x030D, 0x031D, 0x032D, 0x033D, 0x034E, 0x035E, 0x036F, 0x0380, 0x0391, 0x03A2, 0x03B3, 0x03C4, 0x03D6, 0x03E7, 0x03F9, 0x040B, 0x041D, 0x042F, 0x0441, 0x0453, 0x0465, 0x0478, 0x048A, 0x049D, 0x04B0, 0x04C3, 0x04D6, 0x04E9, 0x04FD, 0x0510, 0x0523, 0x0537, 0x054B, 0x055F },
        .bank2 = { 0x0573, 0x0587, 0x059B, 0x05B0, 0x05C4, 0x05D9, 0x05ED, 0x0602, 0x0617, 0x062C, 0x0642, 0x0657, 0x066D, 0x0682, 0x0698, 0x06AE, 0x06C4, 0x06DA, 0x06F0, 0x0707, 0x071D, 0x0734, 0x074A, 0x0761, 0x0778, 0x078F, 0x07A7, 0x07BE, 0x07D6, 0x07ED, 0x0805, 0x081D, 0x0835, 0x084D, 0x0865, 0x087D, 0x0895, 0x08AE, 0x08C6, 0x08DE, 0x08F7, 0x090F, 0x0928, 0x0940, 0x0959, 0x0972, 0x098A, 0x09A3, 0x09BC, 0x09D5, 0x09EE, 0x0A07, 0x0A20, 0x0A39, 0x0A53, 0x0A6C, 0x0A85, 0x0A9F, 0x0AB8, 0x0AD1, 0x0AEB, 0x0B05, 0x0B1E, 0x0B38, 0x0B52, 0x0B6B, 0x0B85, 0x0B9E, 0x0BB8, 0x0BD1, 0x0BEA, 0x0C03, 0x0C1D, 0x0C36, 0x0C4E, 0x0C67, 0x0C80, 0x0C99, 0x0CB1, 0x0CCA, 0x0CE2, 0x0CFA, 0x0D12, 0x0D2B, 0x0D43, 0x0D5B, 0x0D72, 0x0D8A, 0x0DA2, 0x0DB9, 0x0DD1, 0x0DE8, 0x0E00, 0x0E17, 0x0E2E, 0x0E45, 0x0E5C, 0x0E73, 0x0E88, 0x0E9D, 0x0EB2, 0x0EC6, 0x0ED9, 0x0EEC, 0x0EFE, 0x0F0F, 0x0F20, 0x0F30, 0x0F3F, 0x0F4E, 0x0F5C, 0x0F6A, 0x0F77, 0x0F83, 0x0F8F, 0x0F9A, 0x0FA4, 0x0FAE, 0x0FB7, 0x0FC0, 0x0FC8, 0x0FCF, 0x0FD5, 0x0FDB, 0x0FE1, 0x0FE6, 0x0FEA, 0x0FED },
    },
};

const GammaTableParams2 g_gamma_table_params2[UNK_PARAM_COUNT][GAMMA_TABLE_COUNT] = {
    {
        {
            .bank1 = { 0x00, 0x08, 0x0D, 0x11, 0x13, 0x16, 0x18, 0x1A, 0x1C, 0x1D, 0x1F, 0x20, 0x21, 0x23, 0x25, 0x25, 0x26, 0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F, 0x30, 0x31, 0x32, 0x33, 0x33, 0x34, 0x35, 0x36, 0x36, 0x37, 0x38, 0x39, 0x39, 0x3A, 0x3B, 0x3B, 0x3C, 0x3D, 0x3D, 0x3E, 0x3F, 0x40, 0x40, 0x41, 0x41, 0x42, 0x42, 0x43, 0x44, 0x44, 0x45, 0x46, 0x46, 0x47, 0x47, 0x48, 0x48, 0x49, 0x49, 0x4A, 0x4A, 0x4B, 0x4C, 0x4C, 0x4C, 0x4D, 0x4D, 0x4E, 0x4E, 0x4F, 0x4F, 0x4F, 0x50, 0x50, 0x51, 0x51, 0x52, 0x52, 0x53, 0x53, 0x54, 0x54, 0x54, 0x55, 0x55, 0x56, 0x56, 0x57, 0x57, 0x58, 0x58, 0x58, 0x59, 0x59, 0x59, 0x5A, 0x5B, 0x5B, 0x5C, 0x5C, 0x5C, 0x5D, 0x5D, 0x5E, 0x5E, 0x5E, 0x5F, 0x5F, 0x5F, 0x5F, 0x60, 0x60, 0x60, 0x61, 0x61, 0x62, 0x62, 0x62, 0x63, 0x63, 0x64, 0x64, 0x64 },
            .bank2 = { 0x65, 0x65, 0x65, 0x65, 0x66, 0x66, 0x66, 0x66, 0x67, 0x67, 0x68, 0x68, 0x69, 0x69, 0x69, 0x6A, 0x6A, 0x6A, 0x6B, 0x6B, 0x6B, 0x6B, 0x6C, 0x6C, 0x6C, 0x6D, 0x6D, 0x6D, 0x6E, 0x6E, 0x6E, 0x6F, 0x6F, 0x70, 0x70, 0x70, 0x70, 0x71, 0x71, 0x71, 0x72, 0x72, 0x72, 0x72, 0x73, 0x73, 0x73, 0x74, 0x74, 0x74, 0x74, 0x75, 0x75, 0x75, 0x76, 0x76, 0x76, 0x77, 0x77, 0x77, 0x77, 0x77, 0x78, 0x78, 0x79, 0x79, 0x79, 0x7A, 0x7A, 0x7A, 0x7B, 0x7B, 0x7B, 0x7B, 0x7C, 0x7C, 0x7C, 0x7C, 0x7D, 0x7D, 0x7D, 0x7E, 0x7E, 0x7E, 0x7F, 0x7F, 0x7F, 0x7F, 0x80, 0x80, 0x80, 0x80, 0x81, 0x81, 0x81, 0x81, 0x82, 0x82, 0x82, 0x83, 0x83, 0x83, 0x83, 0x84, 0x84, 0x84, 0x84, 0x84, 0x85, 0x85, 0x85, 0x85, 0x86, 0x86, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x88, 0x88, 0x88, 0x88, 0x89, 0x89, 0x89, 0x8A },
        },
        {
            .bank1 = { 0x8A, 0x8A, 0x8A, 0x8B, 0x8B, 0x8B, 0x8B, 0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x8D, 0x8D, 0x8D, 0x8D, 0x8D, 0x8E, 0x8E, 0x8E, 0x8E, 0x8F, 0x8F, 0x8F, 0x8F, 0x90, 0x90, 0x90, 0x90, 0x91, 0x91, 0x91, 0x91, 0x92, 0x92, 0x92, 0x92, 0x93, 0x93, 0x93, 0x93, 0x93, 0x93, 0x93, 0x94, 0x94, 0x94, 0x94, 0x95, 0x95, 0x95, 0x96, 0x96, 0x96, 0x96, 0x96, 0x96, 0x97, 0x97, 0x97, 0x97, 0x98, 0x98, 0x98, 0x98, 0x98, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x9A, 0x9A, 0x9A, 0x9A, 0x9B, 0x9B, 0x9B, 0x9B, 0x9C, 0x9C, 0x9C, 0x9C, 0x9C, 0x9D, 0x9D, 0x9D, 0x9D, 0x9D, 0x9E, 0x9E, 0x9E, 0x9E, 0x9E, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1, 0xA2, 0xA2, 0xA2, 0xA2, 0xA3, 0xA3, 0xA3, 0xA3, 0xA3, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4 },
            .bank2 = { 0xA5, 0xA5, 0xA5, 0xA5, 0xA5, 0xA5, 0xA6, 0xA6, 0xA6, 0xA6, 0xA7, 0xA7, 0xA7, 0xA7, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAB, 0xAB, 0xAB, 0xAC, 0xAC, 0xAC, 0xAC, 0xAC, 0xAC, 0xAD, 0xAD, 0xAD, 0xAD, 0xAD, 0xAD, 0xAE, 0xAE, 0xAE, 0xAE, 0xAE, 0xAE, 0xAE, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xB0, 0xB0, 0xB0, 0xB0, 0xB1, 0xB1, 0xB1, 0xB1, 0xB1, 0xB1, 0xB2, 0xB2, 0xB2, 0xB2, 0xB2, 0xB2, 0xB3, 0xB3, 0xB3, 0xB3, 0xB3, 0xB3, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB5, 0xB5, 0xB5, 0xB5, 0xB6, 0xB6, 0xB6, 0xB6, 0xB6, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB9, 0xB9, 0xB9, 0xB9, 0xB9, 0xBA, 0xBA, 0xBA, 0xBA, 0xBA, 0xBA, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB },
        },
        {
            .bank1 = { 0xBB, 0xBC, 0xBC, 0xBC, 0xBC, 0xBC, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBE, 0xBE, 0xBE, 0xBE, 0xBE, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCB, 0xCB, 0xCB, 0xCB, 0xCB, 0xCB, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCF, 0xCF, 0xCF, 0xCF },
            .bank2 = { 0xCF, 0xCF, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD3, 0xD3, 0xD3, 0xD3, 0xD3, 0xD3, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD5, 0xD5, 0xD5, 0xD5, 0xD5, 0xD5, 0xD5, 0xD6, 0xD6, 0xD6, 0xD6, 0xD6, 0xD6, 0xD6, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD9, 0xD9, 0xD9, 0xD9, 0xD9, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0 },
        },
        {
            .bank1 = { 0xE0, 0xE0, 0xE0, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 },
            .bank2 = { 0xE0, 0xE0, 0xE0, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0 },
        },
    },
    {
        {
            .bank1 = { 0x00, 0x09, 0x0E, 0x11, 0x14, 0x16, 0x18, 0x1A, 0x1C, 0x1D, 0x1F, 0x20, 0x22, 0x23, 0x25, 0x25, 0x26, 0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F, 0x30, 0x31, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x36, 0x37, 0x37, 0x38, 0x39, 0x3A, 0x3A, 0x3B, 0x3B, 0x3C, 0x3D, 0x3D, 0x3E, 0x3F, 0x40, 0x40, 0x41, 0x41, 0x42, 0x42, 0x43, 0x44, 0x44, 0x45, 0x46, 0x46, 0x47, 0x47, 0x48, 0x48, 0x49, 0x49, 0x4A, 0x4A, 0x4B, 0x4C, 0x4C, 0x4C, 0x4D, 0x4D, 0x4E, 0x4E, 0x4E, 0x4F, 0x4F, 0x50, 0x50, 0x51, 0x51, 0x51, 0x52, 0x52, 0x53, 0x54, 0x54, 0x54, 0x55, 0x55, 0x56, 0x56, 0x57, 0x57, 0x58, 0x58, 0x58, 0x58, 0x59, 0x59, 0x59, 0x5A, 0x5B, 0x5B, 0x5B, 0x5C, 0x5C, 0x5D, 0x5D, 0x5D, 0x5E, 0x5E, 0x5F, 0x5F, 0x5F, 0x5F, 0x60, 0x60, 0x60, 0x61, 0x61, 0x61, 0x62, 0x62, 0x63, 0x63, 0x64 },
            .bank2 = { 0x64, 0x64, 0x65, 0x65, 0x65, 0x66, 0x66, 0x66, 0x66, 0x66, 0x67, 0x67, 0x68, 0x68, 0x68, 0x69, 0x69, 0x6A, 0x6A, 0x6A, 0x6B, 0x6B, 0x6B, 0x6B, 0x6C, 0x6C, 0x6C, 0x6C, 0x6D, 0x6D, 0x6D, 0x6E, 0x6E, 0x6E, 0x6F, 0x6F, 0x70, 0x70, 0x70, 0x71, 0x71, 0x71, 0x71, 0x72, 0x72, 0x72, 0x72, 0x73, 0x73, 0x73, 0x73, 0x74, 0x74, 0x74, 0x75, 0x75, 0x75, 0x76, 0x76, 0x76, 0x77, 0x77, 0x77, 0x77, 0x78, 0x78, 0x78, 0x79, 0x79, 0x79, 0x7A, 0x7A, 0x7A, 0x7B, 0x7B, 0x7B, 0x7C, 0x7C, 0x7C, 0x7C, 0x7C, 0x7D, 0x7D, 0x7D, 0x7E, 0x7E, 0x7E, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x80, 0x80, 0x80, 0x80, 0x81, 0x81, 0x81, 0x81, 0x82, 0x82, 0x82, 0x83, 0x83, 0x83, 0x83, 0x84, 0x84, 0x84, 0x84, 0x84, 0x85, 0x85, 0x85, 0x86, 0x86, 0x86, 0x87, 0x87, 0x87, 0x87, 0x87, 0x88, 0x88, 0x88, 0x88, 0x88 },
        },
        {
            .bank1 = { 0x89, 0x89, 0x89, 0x8A, 0x8A, 0x8A, 0x8A, 0x8B, 0x8B, 0x8B, 0x8B, 0x8B, 0x8C, 0x8C, 0x8C, 0x8C, 0x8D, 0x8D, 0x8D, 0x8D, 0x8D, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8F, 0x8F, 0x8F, 0x8F, 0x90, 0x90, 0x90, 0x91, 0x91, 0x91, 0x91, 0x92, 0x92, 0x92, 0x92, 0x92, 0x93, 0x93, 0x93, 0x93, 0x93, 0x93, 0x93, 0x94, 0x94, 0x94, 0x94, 0x95, 0x95, 0x95, 0x96, 0x96, 0x96, 0x96, 0x96, 0x96, 0x97, 0x97, 0x97, 0x97, 0x98, 0x98, 0x98, 0x98, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x9A, 0x9A, 0x9A, 0x9A, 0x9B, 0x9B, 0x9B, 0x9B, 0x9B, 0x9C, 0x9C, 0x9C, 0x9C, 0x9D, 0x9D, 0x9D, 0x9D, 0x9D, 0x9D, 0x9E, 0x9E, 0x9E, 0x9E, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1, 0xA2, 0xA2, 0xA2, 0xA2, 0xA3, 0xA3, 0xA3, 0xA3, 0xA3, 0xA3, 0xA4 },
            .bank2 = { 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xA5, 0xA5, 0xA5, 0xA5, 0xA5, 0xA6, 0xA6, 0xA6, 0xA6, 0xA7, 0xA7, 0xA7, 0xA7, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAB, 0xAB, 0xAB, 0xAB, 0xAC, 0xAC, 0xAC, 0xAC, 0xAC, 0xAD, 0xAD, 0xAD, 0xAD, 0xAD, 0xAD, 0xAE, 0xAE, 0xAE, 0xAE, 0xAE, 0xAE, 0xAE, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xB0, 0xB0, 0xB0, 0xB0, 0xB1, 0xB1, 0xB1, 0xB1, 0xB1, 0xB2, 0xB2, 0xB2, 0xB2, 0xB2, 0xB2, 0xB3, 0xB3, 0xB3, 0xB3, 0xB3, 0xB3, 0xB3, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB5, 0xB5, 0xB5, 0xB5, 0xB6, 0xB6, 0xB6, 0xB6, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB9, 0xB9, 0xB9, 0xB9, 0xB9, 0xB9, 0xBA, 0xBA, 0xBA, 0xBA, 0xBA },
        },
        {
            .bank1 = { 0xBA, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBC, 0xBC, 0xBC, 0xBC, 0xBC, 0xBC, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBE, 0xBE, 0xBE, 0xBE, 0xBE, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCB, 0xCB, 0xCB, 0xCB, 0xCB, 0xCB, 0xCB, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCE, 0xCE, 0xCE, 0xCE },
            .bank2 = { 0xCE, 0xCE, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD3, 0xD3, 0xD3, 0xD3, 0xD3, 0xD3, 0xD3, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD5, 0xD5, 0xD5, 0xD5, 0xD5, 0xD5, 0xD6, 0xD6, 0xD6, 0xD6, 0xD6, 0xD6, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD9, 0xD9, 0xD9, 0xD9, 0xD9, 0xD9, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF },
        },
        {
            .bank1 = { 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xF0, 0xF0 },
            .bank2 = { 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF2, 0xF2, 0xF2, 0xF2, 0xF2, 0xF2, 0xF2, 0xF2, 0xF2, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF6, 0xF6, 0xF6, 0xF6, 0xF6, 0xF6, 0xF6, 0xF6, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xFA, 0xFA, 0xFA, 0xFA, 0xFA, 0xFA, 0xFA, 0xFA, 0xFA, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFF },
        },
    },
    {
        {
            .bank1 = { 0x00, 0x03, 0x0A, 0x0D, 0x10, 0x12, 0x14, 0x16, 0x18, 0x19, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0x20, 0x21, 0x22, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x2A, 0x2B, 0x2C, 0x2C, 0x2D, 0x2E, 0x2F, 0x30, 0x31, 0x31, 0x32, 0x32, 0x33, 0x34, 0x34, 0x35, 0x36, 0x36, 0x37, 0x37, 0x38, 0x38, 0x39, 0x3A, 0x3A, 0x3B, 0x3B, 0x3C, 0x3C, 0x3D, 0x3D, 0x3E, 0x3E, 0x3F, 0x40, 0x40, 0x40, 0x41, 0x41, 0x42, 0x42, 0x43, 0x43, 0x44, 0x44, 0x45, 0x45, 0x46, 0x46, 0x47, 0x47, 0x48, 0x48, 0x48, 0x49, 0x49, 0x4A, 0x4A, 0x4B, 0x4B, 0x4C, 0x4C, 0x4C, 0x4C, 0x4D, 0x4D, 0x4E, 0x4E, 0x4E, 0x4F, 0x4F, 0x4F, 0x50, 0x50, 0x50, 0x51, 0x51, 0x51, 0x52, 0x52, 0x53, 0x53, 0x54, 0x54, 0x54, 0x54, 0x55, 0x55, 0x55, 0x56, 0x56, 0x57, 0x57, 0x57, 0x58, 0x58, 0x58, 0x58, 0x59, 0x59, 0x59, 0x5A, 0x5A },
            .bank2 = { 0x5B, 0x5B, 0x5B, 0x5C, 0x5C, 0x5C, 0x5C, 0x5D, 0x5D, 0x5E, 0x5E, 0x5E, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x60, 0x60, 0x60, 0x60, 0x61, 0x61, 0x62, 0x62, 0x62, 0x63, 0x63, 0x63, 0x64, 0x64, 0x64, 0x65, 0x65, 0x65, 0x65, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x67, 0x67, 0x67, 0x68, 0x68, 0x69, 0x69, 0x69, 0x6A, 0x6A, 0x6A, 0x6A, 0x6B, 0x6B, 0x6B, 0x6B, 0x6B, 0x6C, 0x6C, 0x6C, 0x6C, 0x6D, 0x6D, 0x6D, 0x6D, 0x6E, 0x6E, 0x6E, 0x6F, 0x6F, 0x6F, 0x70, 0x70, 0x70, 0x70, 0x71, 0x71, 0x71, 0x71, 0x72, 0x72, 0x72, 0x72, 0x73, 0x73, 0x73, 0x73, 0x73, 0x74, 0x74, 0x74, 0x74, 0x75, 0x75, 0x75, 0x76, 0x76, 0x76, 0x76, 0x77, 0x77, 0x77, 0x77, 0x77, 0x78, 0x78, 0x78, 0x78, 0x79, 0x79, 0x79, 0x7A, 0x7A, 0x7A, 0x7B, 0x7B, 0x7B, 0x7B, 0x7C, 0x7C, 0x7C, 0x7C, 0x7C, 0x7C, 0x7D, 0x7D },
        },
        {
            .bank1 = { 0x7D, 0x7E, 0x7E, 0x7E, 0x7E, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x80, 0x80, 0x80, 0x80, 0x80, 0x81, 0x81, 0x81, 0x81, 0x82, 0x82, 0x82, 0x83, 0x83, 0x83, 0x83, 0x84, 0x84, 0x84, 0x84, 0x84, 0x84, 0x84, 0x85, 0x85, 0x85, 0x86, 0x86, 0x86, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x88, 0x88, 0x88, 0x88, 0x88, 0x89, 0x89, 0x89, 0x89, 0x8A, 0x8A, 0x8A, 0x8A, 0x8B, 0x8B, 0x8B, 0x8B, 0x8B, 0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x8D, 0x8D, 0x8D, 0x8D, 0x8D, 0x8E, 0x8E, 0x8E, 0x8E, 0x8E, 0x8F, 0x8F, 0x8F, 0x8F, 0x8F, 0x90, 0x90, 0x90, 0x90, 0x90, 0x91, 0x91, 0x91, 0x91, 0x92, 0x92, 0x92, 0x92, 0x92, 0x93, 0x93, 0x93, 0x93, 0x93, 0x93, 0x93, 0x94, 0x94, 0x94, 0x94, 0x94, 0x94, 0x95, 0x95, 0x95, 0x96, 0x96, 0x96, 0x96, 0x96, 0x96, 0x97, 0x97, 0x97, 0x97, 0x97, 0x98 },
            .bank2 = { 0x98, 0x98, 0x98, 0x98, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x9A, 0x9A, 0x9A, 0x9A, 0x9A, 0x9B, 0x9B, 0x9B, 0x9B, 0x9B, 0x9C, 0x9C, 0x9C, 0x9C, 0x9C, 0x9D, 0x9D, 0x9D, 0x9D, 0x9D, 0x9D, 0x9E, 0x9E, 0x9E, 0x9E, 0x9E, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0x9F, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xA0, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1, 0xA2, 0xA2, 0xA2, 0xA2, 0xA2, 0xA2, 0xA3, 0xA3, 0xA3, 0xA3, 0xA3, 0xA3, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xA5, 0xA5, 0xA5, 0xA5, 0xA5, 0xA6, 0xA6, 0xA6, 0xA6, 0xA6, 0xA7, 0xA7, 0xA7, 0xA7, 0xA7, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAB, 0xAB, 0xAB, 0xAB, 0xAB, 0xAC, 0xAC, 0xAC, 0xAC, 0xAC, 0xAC, 0xAD, 0xAD, 0xAD, 0xAD, 0xAD, 0xAD, 0xAE, 0xAE, 0xAE },
        },
        {
            .bank1 = { 0xAE, 0xAE, 0xAE, 0xAE, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xB0, 0xB0, 0xB0, 0xB0, 0xB0, 0xB1, 0xB1, 0xB1, 0xB1, 0xB1, 0xB1, 0xB2, 0xB2, 0xB2, 0xB2, 0xB2, 0xB3, 0xB3, 0xB3, 0xB3, 0xB3, 0xB3, 0xB3, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB5, 0xB5, 0xB5, 0xB5, 0xB5, 0xB6, 0xB6, 0xB6, 0xB6, 0xB6, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB7, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB8, 0xB9, 0xB9, 0xB9, 0xB9, 0xB9, 0xB9, 0xBA, 0xBA, 0xBA, 0xBA, 0xBA, 0xBA, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBC, 0xBC, 0xBC, 0xBC, 0xBC, 0xBC, 0xBC, 0xBD, 0xBD, 0xBD, 0xBD, 0xBE, 0xBE, 0xBE, 0xBE, 0xBE, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC1, 0xC2, 0xC2, 0xC2, 0xC2 },
            .bank2 = { 0xC2, 0xC2, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC7, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xC9, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCB, 0xCB, 0xCB, 0xCB, 0xCB, 0xCB, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCE, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xCF, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD0, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD1, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD2, 0xD3, 0xD3, 0xD3, 0xD3, 0xD3, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD4, 0xD5, 0xD5, 0xD5, 0xD5, 0xD5, 0xD5, 0xD5, 0xD6 },
        },
        {
            .bank1 = { 0xD6, 0xD6, 0xD6, 0xD6, 0xD6, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD9, 0xD9, 0xD9, 0xD9, 0xD9, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDA, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDB, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDC, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDD, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDE, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE1, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE2, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE4, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE5, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE6, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE7, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE8, 0xE9 },
            .bank2 = { 0xE9, 0xE9, 0xE9, 0xE9, 0xE9, 0xEA, 0xEA, 0xEA, 0xEA, 0xEA, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEB, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xEC, 0xED, 0xED, 0xED, 0xED, 0xED, 0xED, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEE, 0xEF, 0xEF, 0xEF, 0xEF, 0xEF, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF1, 0xF2, 0xF2, 0xF2, 0xF2, 0xF2, 0xF2, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xF3, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF4, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF5, 0xF6, 0xF6, 0xF6, 0xF6, 0xF6, 0xF6, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xF9, 0xFA, 0xFA, 0xFA, 0xFA, 0xFA, 0xFB, 0xFB, 0xFB, 0xFB, 0xFB, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFD, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE },
        }
    }
};

static unsigned char g_unk_cmd_4[] = {
    0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0xA7, 0xA7, 0xA7, 0xA7, 0xA7, 0xA7, 0xA7, 0xA7, 0xA7, 0xA7, 0xA6, 0xA6, 0xA6, 0xA6, 0xA6, 0xA6, 0xA6, 0xA6, 0xA5, 0xA5, 0xA5, 0xA5, 0xA5, 0xA5, 0xA5, 0xA4, 0xA4, 0xA4, 0xA4, 0xA4, 0xA3, 0xA3, 0xA3, 0xA3, 0xA3, 0xA2, 0xA2, 0xA2, 0xA2, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1, 0xA0, 0xA0, 0xA0, 0x9F, 0x9F, 0x9F, 0x9F, 0x9E, 0x9E, 0x9E, 0x9D, 0x9D, 0x9D, 0x9D, 0x9C, 0x9C, 0x9C, 0x9B, 0x9B, 0x9B, 0x9A, 0x9A, 0x99, 0x99, 0x99, 0x98, 0x98, 0x98, 0x97, 0x97, 0x96, 0x96, 0x95, 0x95, 0x95, 0x94, 0x94, 0x93, 0x93, 0x93, 0x92, 0x92, 0x91, 0x91, 0x90, 0x90, 0x8F, 0x8F, 0x8E, 0x8E, 0x8D, 0x8D, 0x8C, 0x8C, 0x8B, 0x8B, 0x8A, 0x8A, 0x89, 0x89, 0x88
};

static unsigned char g_unk_cmd_5[] = {
    0x87, 0x87, 0x86, 0x86, 0x85, 0x85, 0x84, 0x83, 0x83, 0x82, 0x81, 0x81, 0x80, 0x7f, 0x7f, 0x7e, 0x7d, 0x7d, 0x7c, 0x7b, 0x7b, 0x7a, 0x79, 0x79, 0x78, 0x77, 0x76, 0x76, 0x75, 0x74, 0x73, 0x72, 0x72, 0x71, 0x70, 0x6f, 0x6f, 0x6e, 0x6d, 0x6c, 0x6b, 0x6a, 0x6a, 0x69, 0x68, 0x67, 0x66, 0x65, 0x64, 0x63, 0x63, 0x62, 0x61, 0x60, 0x5f, 0x5e, 0x5d, 0x5c, 0x5b, 0x5a, 0x59, 0x58, 0x57, 0x56, 0x55, 0x54, 0x53, 0x52, 0x50, 0x4f, 0x4e, 0x4d, 0x4c, 0x4b, 0x4a, 0x49, 0x47, 0x46, 0x45, 0x44, 0x43, 0x42, 0x40, 0x3f, 0x3e, 0x3d, 0x3b, 0x3a, 0x39, 0x37, 0x36, 0x35, 0x34, 0x32, 0x31, 0x2f, 0x2e, 0x2d, 0x2b, 0x2a, 0x29, 0x27, 0x26, 0x24, 0x23, 0x21, 0x20, 0x1e, 0x1d, 0x1b, 0x1a, 0x18, 0x17, 0x15, 0x14, 0x12, 0x10, 0x0f, 0x0d, 0x0b, 0x0a, 0x08, 0x06, 0x05, 0x03, 0x01, 0x01, 0x00
};

static unsigned char g_unk_cmd_6[] = {
    0x00, 0x22, 0x45, 0x83, 0xa2, 0xb5, 0xc2, 0xcb, 0xd1, 0xd6, 0xdb, 0xde, 0xe1, 0xe3, 0xe5, 0xe7, 0xe9
};

static unsigned char g_unk_cmd_7[] = {
    0x00, 0x12, 0x28, 0x42, 0x60, 0x78, 0x8a, 0x97, 0xa1, 0xa8, 0xaf, 0xb4, 0xb9, 0xbc, 0xbf, 0xc2, 0xc3
};

static unsigned char g_unk_cmd_8[] = {
    0x00, 0x22, 0x45, 0x83, 0xa2, 0xb5, 0xc2, 0xcb, 0xd1, 0xd6, 0xdb, 0xde, 0xe1, 0xe3, 0xe5, 0xe7, 0xe9
};

static unsigned char g_unk_cmd_9[] = {
    0x00, 0x12, 0x28, 0x42, 0x60, 0x78, 0x8a, 0x97, 0xa1, 0xa8, 0xaf, 0xb4, 0xb9, 0xbc, 0xbf, 0xc2, 0xc3
};

#define GAMMA_TABLE_COUNT   (4)

static SamanthaState *samantha_state(void)
{
    static SamanthaState state;
    return &state;
}

static int is_resetted(void)
{
    return (gpio_read() & GPIO_PORT_LCD_RESET) == 0;
}

static void reset_disable(void)
{
    gpio_set(GPIO_PORT_LCD_RESET);
}

static void reset_enable(void)
{
    gpio_clear(GPIO_PORT_LCD_RESET);
}

static void enable_backlight(void)
{    
    while (pwm_enable_channel(1, 0x18, 0x19, 0x19) < 0);
    while (1) {
        uint32_t unk;
        pwm_query_channel(1, NULL, NULL, &unk);

        if (unk != 0) {
            break;
        }
    }
}

static void disable_backlight(void)
{
    pwm_disable_channel(1);
    while (1) {
        uint32_t unk;
        pwm_query_channel(1, NULL, NULL, &unk);

        if (unk == 0) {
            break;
        }
    }
}

static void enable_device(SamanthaState *state, int do_bl_disable)
{
    if (do_bl_disable) {
        state->is_enabled_without_backlight = 1;
        disable_backlight();
    }

    sysreg_clk2_enable(CLK2_SPI1);

    while (spi_is_data_available(SPI_HIBARI)) {
        (void)spi_read(SPI_HIBARI);
    }

    spi_enable_ssp(SPI_HIBARI);
    cpu_sync();
}

static void disable_device(SamanthaState *state)
{
    while(spi_is_busy(SPI_HIBARI));
    spi_disable_ssp(SPI_HIBARI);
    cpu_sync();
    sysreg_clk2_disable(CLK2_SPI1);

    if (state->is_enabled_without_backlight) {
        state->is_enabled_without_backlight = 0;
        enable_backlight();
    }
}

static unsigned char read_controller_register(SamanthaState *state, unsigned int bank, unsigned int reg)
{
    enable_device(state, 0);

    if (state->active_device != SAMANTHA_DEV_CONTROLLER && reg != 0xCF) {
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, 0xCF00);
        state->active_device = SAMANTHA_DEV_CONTROLLER;
    }

    if (state->active_bank != bank && reg != 0xEF) {
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, 0xEF00 | bank);
        state->active_bank = bank;
    }

    while (spi_is_busy(SPI_HIBARI));
    while (spi_is_data_available(SPI_HIBARI)) {
        (void)spi_read(SPI_HIBARI);
    }
    while (spi_is_transmit_fifo_full(SPI_HIBARI));
    spi_write(SPI_HIBARI, 0xC100 | reg);
    while (!spi_is_data_available(SPI_HIBARI));
    (void)spi_read(SPI_HIBARI);
    while (spi_is_transmit_fifo_full(SPI_HIBARI));
    spi_write(SPI_HIBARI, 0xC200);
    while (!spi_is_data_available(SPI_HIBARI));
    unsigned char reg_value = spi_read(SPI_HIBARI);

    disable_device(state);
    return reg_value & 0xFF;
}

static void write_driver_single_register(SamanthaState *state, unsigned int reg, unsigned int val)
{
    enable_device(state, 0);

    if (state->active_device != SAMANTHA_DEV_DRIVER && reg != 0xCF) {
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, 0xCF01);
        state->active_device = SAMANTHA_DEV_DRIVER;
    }

    while (spi_is_transmit_fifo_full(SPI_HIBARI));
    spi_write(SPI_HIBARI, (reg << 8) | val);

    disable_device(state);
}

static void write_controller_single_register(SamanthaState *state, unsigned int bank, unsigned int reg, unsigned int val)
{
    enable_device(state, 0);

    if (state->active_device != SAMANTHA_DEV_CONTROLLER && reg != 0xCF) {
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, 0xCF00);
        state->active_device = SAMANTHA_DEV_CONTROLLER;
    }

    if (state->active_bank != bank && reg != 0xEF) {
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, 0xEF00 | bank);
        state->active_bank = bank;
    }

    while (spi_is_transmit_fifo_full(SPI_HIBARI));
    spi_write(SPI_HIBARI, (reg << 8) | val);

    if (reg == 0xEF) {
        state->active_bank = val;
    }

    disable_device(state);
}

static void write_controller_continuous_register(SamanthaState *state, unsigned int bank, unsigned int reg, const uint8_t *data, size_t len)
{
    if (state->active_device != SAMANTHA_DEV_CONTROLLER && reg != 0xCF) {
        enable_device(state, 0);
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, 0xCF00);
        state->active_device = SAMANTHA_DEV_CONTROLLER;
        disable_device(state);
    }

    if (state->active_bank != bank && reg != 0xEF) {
        enable_device(state, 0);
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, 0xEF00 | bank);
        state->active_bank = bank;
        disable_device(state);
    }

    enable_device(state, 1);

    if ((len % 2) == 0) {
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, 0xC400 | reg);
    }
    else {
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, (reg << 8) | *data);

        if (reg == 0xEF) {
            state->active_bank = *data;
        }

        reg += 1;
        len -= 1;
        data++;
    }

    for (size_t i = 0; i < len; i += 2, reg += 2) {
        while (spi_is_transmit_fifo_full(SPI_HIBARI));
        spi_write(SPI_HIBARI, ((uint16_t)data[i] << 8) | data[i + 1]);

        if (reg == 0xEF) {
            state->active_bank = data[i];
        }

        else if (reg == 0xEE) {
            state->active_bank = data[i + 1];
        }
    }

    disable_device(state);
}

static void select_bank(SamanthaState *state, unsigned int bank)
{
    write_controller_single_register(state, 0, 0xEF, bank);
}

static void unk_1(SamanthaState *state, const GammaTableParams *params)
{
    write_controller_single_register(state, 0, 0xD0, state->controller_flag & 0xFC);

    for (size_t i = 0; i < UNK_PARAM_COUNT; ++i) {
        select_bank(state, 1);

        for (size_t j = 0; j < 0x80; ++j) {
            uint16_t param = params[i].bank1[j];
            write_controller_single_register(state, 1, 0xD1, ((param >> 4) & 0xF0) | (4 >> i));
            write_controller_single_register(state, 1, j, param & 0xFF);
        }

        select_bank(state, 2);

        for (size_t j = 0; j < 0x80; ++j) {
            uint16_t param = params[i].bank2[j];
            write_controller_single_register(state, 2, 0xD1, ((param >> 4) & 0xF0) | (4 >> i));
            write_controller_single_register(state, 2, j, param & 0xFF);
        }
    }

    write_controller_single_register(state, 2, 0xD1, 0);
    write_controller_single_register(state, 0, 0xD0, state->controller_flag);
}

static void unk_2(SamanthaState *state, const GammaTableParams2 (*params)[GAMMA_TABLE_COUNT])
{
    write_controller_single_register(state, 0, 0xD0, state->controller_flag & 0xFC);

    for (size_t i = 0; i < UNK_PARAM_COUNT; ++i) {
        for (size_t j = 0; j < GAMMA_TABLE_COUNT; ++j) {
            uint8_t selection = (j << 4) | (4 >> i);
            select_bank(state, 3);
            write_controller_single_register(state, 3, 0xD2, selection);
            write_controller_continuous_register(state, 3, 0, params[i][j].bank1, 0x80);
            select_bank(state, 4);
            write_controller_single_register(state, 4, 0xD2, selection);
            write_controller_continuous_register(state, 4, 0, params[i][j].bank2, 0x80);
        }
    }

    write_controller_single_register(state, 4, 0xD2, 0);
    write_controller_single_register(state, 0, 0xD0, state->controller_flag);
}

static void sequence_process(SamanthaState *state)
{
    if (!state->sequence) {
        return;
    }

    for (const SequenceCommand *sequence = state->sequence; sequence->cmd != SEQ_CMD_TERM; ++sequence)
    {
        switch (sequence->cmd)
        {
            case SEQ_CMD_CONTROLLER_SINGLE_REG:
                write_controller_single_register(state, 0, sequence->reg, sequence->value);
                break;
            
            case SEQ_CMD_DRIVER_SINGLE_REG:
                write_driver_single_register(state, sequence->reg, sequence->value);
                break;

            case SEQ_CMD_UNK_2:
                unk_1(state, g_gamma_table_params1);
                break;

            case SEQ_CMD_GAMMA_TABLE:
                unk_2(state, g_gamma_table_params2);
                break;

            case SEQ_CMD_UNK_4:
                write_controller_single_register(state, 0, 0xD0, state->controller_flag & ~CONTROLLER_LOCKED);
                write_controller_single_register(state, 0, sequence->reg, sequence->value);
                write_controller_continuous_register(state, 5, 0, g_unk_cmd_4, sizeof(g_unk_cmd_4));
                write_controller_single_register(state, 0, 0xD0, state->controller_flag);
                break;

            case SEQ_CMD_UNK_5:
                write_controller_single_register(state, 0, 0xD0, state->controller_flag & ~CONTROLLER_LOCKED);
                write_controller_single_register(state, 0, sequence->reg, sequence->value);
                write_controller_continuous_register(state, 6, 0, g_unk_cmd_5, sizeof(g_unk_cmd_5));
                write_controller_single_register(state, 0, 0xD0, state->controller_flag);
                break;

            case SEQ_CMD_UNK_6:
                write_controller_single_register(state, 0, 0xD0, state->controller_flag & ~CONTROLLER_LOCKED);
                write_controller_single_register(state, 0, sequence->reg, sequence->value);
                write_controller_continuous_register(state, 7, 0, g_unk_cmd_6, sizeof(g_unk_cmd_6));
                write_controller_single_register(state, 0, 0xD0, state->controller_flag);
                break;

            case SEQ_CMD_UNK_7:
                write_controller_single_register(state, 0, 0xD0, state->controller_flag & ~CONTROLLER_LOCKED);
                write_controller_single_register(state, 0, sequence->reg, sequence->value);
                write_controller_continuous_register(state, 7, 0, g_unk_cmd_7, sizeof(g_unk_cmd_7));
                write_controller_single_register(state, 0, 0xD0, state->controller_flag);
                break;

            case SEQ_CMD_UNK_8:
                write_controller_single_register(state, 0, 0xD0, state->controller_flag & ~CONTROLLER_LOCKED);
                write_controller_single_register(state, 0, sequence->reg, sequence->value);
                write_controller_continuous_register(state, 7, 0, g_unk_cmd_8, sizeof(g_unk_cmd_8));
                write_controller_single_register(state, 0, 0xD0, state->controller_flag);
                break;

            case SEQ_CMD_UNK_9:
                write_controller_single_register(state, 0, 0xD0, state->controller_flag & ~CONTROLLER_LOCKED);
                write_controller_single_register(state, 0, sequence->reg, sequence->value);
                write_controller_continuous_register(state, 7, 0, g_unk_cmd_9, sizeof(g_unk_cmd_9));
                write_controller_single_register(state, 0, 0xD0, state->controller_flag);
                break;

            case SEQ_CMD_FLAG_MODIFY:
                if (sequence->value) {
                    state->controller_flag |= sequence->reg;
                }
                else {
                    state->controller_flag &= ~sequence->reg;
                }
                write_controller_single_register(state, 0, 0xD0, state->controller_flag);
                break;

            case SEQ_CMD_WAIT_DELAY:
                for (size_t i = 0; i < sequence->reg; ++i) {
                    util_delay_cpu222_us(16666);
                }
                break;

            case SEQ_CMD_TERM:
                // this shouldn't be possible, but if it happens just exit
                state->sequence = NULL;
                return;
        }
    }

    state->sequence = NULL;
}

static void sequence_execute(SamanthaState *state, SequenceCommand *sequence)
{
    state->sequence = sequence;
    sequence_process(state);
}

static unsigned int get_version(SamanthaState *state)
{
    return read_controller_register(state, 0, 0);
}

static HibariResult reset_sequence(SamanthaState *state)
{
    reset_disable();

    util_delay_cpu222_us(10*1000);

    write_controller_single_register(state, 0, 0xC0, 1);

    util_delay_cpu222_us(50);

    g_seq_tcomdc[0].value = 0x17;
    g_seq_tcomdc[1].value = 1;

    sequence_execute(state, g_seq_init);
    sequence_execute(state, g_seq_tcomdc);
    sequence_execute(state, g_seq_setup);

    return HIBARI_RES_OK;
}

static void update_display_state(SamanthaState *state)
{
    if (state->active_display_state != state->requested_display_state) {
        switch (state->requested_display_state) {
            case DISPLAY_OFF:
                // TODO: add display off sequence?
                state->active_display_state = DISPLAY_OFF;
                break;

            case DISPLAY_ON:
                sequence_execute(state, g_seq_display_on);
                state->active_display_state = DISPLAY_ON;
                state->active_brightness = 0;
                state->vsync_defer = 30;
                break;
        }
    }
}

LcdDriverResult samantha_init(void)
{
    switch (model_get_identity()->model) {
        case PSP_MODEL_03G:
        case PSP_MODEL_04G:
        case PSP_MODEL_09G:
        case PSP_MODEL_05G:
            break;

        default:
            return LCD_DRIVER_ERR_BAD_MODEL;
    }

    enable_backlight();

    sysreg_clock_select_spi(1, 3);
    sysreg_clk2_enable(CLK2_SPI1);
    sysreg_io_enable(IO_SPI1);

    spi_init(SPI_HIBARI);
    cpu_sync();

    sysreg_clk2_disable(CLK2_SPI1);
    gpio_set_port_mode(GPIO_PORT_LCD_RESET, GPIO_MODE_OUTPUT);

    SamanthaState *state = samantha_state();
    state->active_brightness = 0;
    state->requested_brightness = 0;
    state->active_display_state = DISPLAY_OFF;
    state->requested_display_state = DISPLAY_OFF;
    state->vsync_defer = 0;
    state->backlight_state = BACKLIGHT_NO_ACTION;
    state->controller_flag = CONTROLLER_LOCKED;
    state->active_bank = INVALID_REG_VALUE;
    state->active_device = SAMANTHA_DEV_CONTROLLER;

    unsigned int version;
    if (!is_resetted()) {
        version = get_version(state);
    } else {
        reset_disable();
        util_delay_cpu222_us(10*1000);
        version = get_version(state);
        reset_enable();
    }

    if (version != 0xD7) {
        return HIBARI_UNKNOWN_VERSION;
    }

    reset_sequence(state);
    return LCD_DRIVER_RES_OK;
}

LcdDriverResult samantha_set_mode(int mode, unsigned int xres, unsigned int yres, unsigned int stride, unsigned int format)
{
    return LCD_DRIVER_ERR_NOT_IMPL;
}

LcdDriverResult samantha_set_backlight_brightness(unsigned int brightness)
{
    samantha_state()->requested_brightness = brightness;
    return LCD_DRIVER_RES_OK;
}

LcdDriverResult samantha_enable_display(void)
{
    samantha_state()->requested_display_state = DISPLAY_ON;
    return LCD_DRIVER_RES_OK;
}

LcdDriverResult samantha_disable_display(void)
{
    samantha_state()->requested_display_state = DISPLAY_OFF;
    return LCD_DRIVER_RES_OK;
}

LcdDriverResult samantha_on_interrupt(void)
{
    SamanthaState *state = samantha_state();
    update_display_state(state);

    // reduce vsync deferral counter
    if (state->vsync_defer) {
        state->vsync_defer -= 1;
    }

    // set the backlight if the deferral has passed and the display is on
    if (state->active_display_state == DISPLAY_ON && state->vsync_defer == 0) {
        // set the brightness if we have a new value
        if (state->active_brightness != state->requested_brightness) {
            sequence_execute(state, g_seq_backlight_on);
            state->active_brightness = state->requested_brightness;
        }
    }

    return LCD_DRIVER_RES_OK;
}

const LcdDriver g_samantha_driver = 
{
    .init = samantha_init,
    .set_mode = samantha_set_mode,
    .set_backlight_brightness = samantha_set_backlight_brightness,
    .enable_display = samantha_enable_display,
    .disable_display = samantha_disable_display,
    .on_interrupt = samantha_on_interrupt,
};
